<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neo4j å›¾è°±æµ‹è¯•é¡µé¢</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #0f172a; color: white; }
        .test-result { padding: 1rem; margin: 0.5rem 0; border-radius: 0.5rem; }
        .success { background: rgba(16, 185, 129, 0.2); border: 1px solid #10b981; }
        .error { background: rgba(239, 68, 68, 0.2); border: 1px solid #ef4444; }
        .info { background: rgba(59, 130, 246, 0.2); border: 1px solid #3b82f6; }
    </style>
</head>
<body class="p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-8">ğŸ§ª Neo4j çŸ¥è¯†å›¾è°±è¯Šæ–­å·¥å…·</h1>
        
        <div id="results"></div>
        
        <div class="mt-8">
            <h2 class="text-xl font-bold mb-4">å›¾è°±é¢„è§ˆ</h2>
            <div id="graphPreview" class="bg-slate-800 p-4 rounded-lg min-h-[400px]"></div>
        </div>
        
        <div class="mt-8">
            <button onclick="runTests()" class="px-6 py-3 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg font-semibold">
                ğŸ”„ é‡æ–°æµ‹è¯•
            </button>
        </div>
    </div>

    <script>
        const resultsDiv = document.getElementById('results');
        const graphPreview = document.getElementById('graphPreview');
        
        function addResult(title, status, message, data = null) {
            const div = document.createElement('div');
            div.className = `test-result ${status}`;
            
            let html = `<h3 class="font-bold mb-2">${title}</h3>`;
            html += `<p>${message}</p>`;
            
            if (data) {
                html += `<pre class="mt-2 text-xs overflow-auto">${JSON.stringify(data, null, 2).substring(0, 500)}</pre>`;
            }
            
            div.innerHTML = html;
            resultsDiv.appendChild(div);
        }
        
        async function testAPI() {
            addResult('ğŸ“¡ æµ‹è¯• 1: APIç«¯ç‚¹è¿é€šæ€§', 'info', 'æ­£åœ¨æµ‹è¯• /api/graph/global...');
            
            try {
                const response = await fetch('/api/graph/global');
                
                if (!response.ok) {
                    addResult('âŒ APIè¯·æ±‚å¤±è´¥', 'error', `HTTP ${response.status}: ${response.statusText}`);
                    return null;
                }
                
                const data = await response.json();
                
                if (data.success) {
                    addResult(
                        'âœ… APIè¯·æ±‚æˆåŠŸ', 
                        'success', 
                        `æ•°æ®æº: ${data.source}\nèŠ‚ç‚¹æ•°: ${data.nodes?.length || 0}\nå…³ç³»æ•°: ${data.links?.length || 0}`,
                        {
                            source: data.source,
                            totalNodes: data.totalNodes || data.nodes?.length,
                            totalLinks: data.totalRelationships || data.links?.length,
                            timestamp: data.timestamp
                        }
                    );
                    return data;
                } else {
                    addResult('âŒ APIè¿”å›é”™è¯¯', 'error', JSON.stringify(data));
                    return null;
                }
                
            } catch (error) {
                addResult('âŒ APIè¯·æ±‚å¼‚å¸¸', 'error', error.message);
                return null;
            }
        }
        
        function testDataStructure(data) {
            if (!data) return;
            
            addResult('ğŸ“Š æµ‹è¯• 2: æ•°æ®ç»“æ„éªŒè¯', 'info', 'æ£€æŸ¥æ•°æ®æ ¼å¼...');
            
            const issues = [];
            
            if (!Array.isArray(data.nodes)) {
                issues.push('âŒ nodesä¸æ˜¯æ•°ç»„');
            } else if (data.nodes.length === 0) {
                issues.push('âš ï¸ nodesæ•°ç»„ä¸ºç©º');
            }
            
            if (!Array.isArray(data.links)) {
                issues.push('âŒ linksä¸æ˜¯æ•°ç»„');
            } else if (data.links.length === 0) {
                issues.push('âš ï¸ linksæ•°ç»„ä¸ºç©º');
            }
            
            if (issues.length > 0) {
                addResult('âš ï¸ æ•°æ®ç»“æ„é—®é¢˜', 'error', issues.join('\n'));
            } else {
                addResult('âœ… æ•°æ®ç»“æ„æ­£å¸¸', 'success', `åŒ…å« ${data.nodes.length} ä¸ªèŠ‚ç‚¹å’Œ ${data.links.length} ä¸ªå…³ç³»`);
                
                // æ˜¾ç¤ºç¤ºä¾‹èŠ‚ç‚¹
                if (data.nodes.length > 0) {
                    addResult('ğŸ“ ç¤ºä¾‹èŠ‚ç‚¹', 'info', 'ç¬¬ä¸€ä¸ªèŠ‚ç‚¹çš„ç»“æ„:', data.nodes[0]);
                }
            }
        }
        
        function visualizeData(data) {
            if (!data || !data.nodes || data.nodes.length === 0) {
                graphPreview.innerHTML = '<p class="text-gray-400">æ— æ•°æ®å¯æ˜¾ç¤º</p>';
                return;
            }
            
            addResult('ğŸ¨ æµ‹è¯• 3: æ•°æ®å¯è§†åŒ–', 'info', 'ç”Ÿæˆç®€å•çš„èŠ‚ç‚¹åˆ—è¡¨...');
            
            let html = '<div class="space-y-2">';
            
            // æŒ‰ç±»å‹åˆ†ç»„èŠ‚ç‚¹
            const nodesByType = {};
            data.nodes.forEach(node => {
                const type = node.label || 'Unknown';
                if (!nodesByType[type]) {
                    nodesByType[type] = [];
                }
                nodesByType[type].push(node);
            });
            
            // æ˜¾ç¤ºå„ç±»å‹èŠ‚ç‚¹
            for (const [type, nodes] of Object.entries(nodesByType)) {
                html += `<div class="bg-slate-700 p-3 rounded">`;
                html += `<h4 class="font-bold text-emerald-400">${type} (${nodes.length})</h4>`;
                html += `<ul class="mt-2 text-sm">`;
                nodes.slice(0, 5).forEach(node => {
                    html += `<li class="text-gray-300">â€¢ ${node.name || node.id}</li>`;
                });
                if (nodes.length > 5) {
                    html += `<li class="text-gray-500">... è¿˜æœ‰ ${nodes.length - 5} ä¸ª</li>`;
                }
                html += `</ul></div>`;
            }
            
            html += '</div>';
            graphPreview.innerHTML = html;
            
            addResult('âœ… å¯è§†åŒ–ç”ŸæˆæˆåŠŸ', 'success', `æ˜¾ç¤ºäº† ${Object.keys(nodesByType).length} ç§ç±»å‹çš„èŠ‚ç‚¹`);
        }
        
        function checkForceGraphLibrary() {
            addResult('ğŸ“š æµ‹è¯• 4: Force Graphåº“æ£€æŸ¥', 'info', 'æ£€æŸ¥ä¾èµ–åº“æ˜¯å¦åŠ è½½...');
            
            if (typeof ForceGraph !== 'undefined') {
                addResult('âœ… Force Graphåº“å·²åŠ è½½', 'success', 'ForceGraphå‡½æ•°å¯ç”¨');
            } else {
                addResult('âŒ Force Graphåº“æœªåŠ è½½', 'error', 'è¯·ç¡®è®¤index.htmlä¸­åŒ…å«äº†Force Graphçš„CDNé“¾æ¥');
            }
        }
        
        async function runTests() {
            resultsDiv.innerHTML = '';
            graphPreview.innerHTML = '<p class="text-gray-400 animate-pulse">åŠ è½½ä¸­...</p>';
            
            addResult('ğŸš€ å¼€å§‹è¯Šæ–­', 'info', 'è¿è¡Œæ‰€æœ‰æµ‹è¯•...');
            
            // æµ‹è¯•1: API
            const data = await testAPI();
            
            // æµ‹è¯•2: æ•°æ®ç»“æ„
            testDataStructure(data);
            
            // æµ‹è¯•3: å¯è§†åŒ–
            visualizeData(data);
            
            // æµ‹è¯•4: åº“æ£€æŸ¥
            checkForceGraphLibrary();
            
            // æ€»ç»“
            addResult(
                'ğŸ“‹ è¯Šæ–­å®Œæˆ', 
                'info', 
                'å¦‚æœä¸Šé¢æ˜¾ç¤ºé”™è¯¯ï¼Œè¯·æ ¹æ®æç¤ºè§£å†³ã€‚å¦‚æœæ‰€æœ‰æµ‹è¯•é€šè¿‡ä½†ä»ç„¶çœ‹ä¸åˆ°å›¾è°±ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°ï¼ˆF12ï¼‰æŸ¥çœ‹JavaScripté”™è¯¯ã€‚'
            );
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡Œæµ‹è¯•
        window.addEventListener('DOMContentLoaded', runTests);
    </script>
</body>
</html>
