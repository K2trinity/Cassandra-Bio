{% extends "base.html" %}

{% block title %}Mission Control - Cassandra{% endblock %}

{% block head %}
<!-- Force Graph Library for Knowledge Graph Visualization -->
<script src="https://unpkg.com/force-graph@1.43.0/dist/force-graph.min.js"></script>

<!-- Marked.js for Markdown Rendering -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<style>
    /* Markdown Styling */
    .prose h1 { font-size: 2rem; font-weight: bold; margin-top: 1.5rem; margin-bottom: 1rem; color: #1a202c; }
    .prose h2 { font-size: 1.5rem; font-weight: bold; margin-top: 1.25rem; margin-bottom: 0.75rem; color: #2d3748; border-bottom: 2px solid #e2e8f0; padding-bottom: 0.5rem; }
    .prose h3 { font-size: 1.25rem; font-weight: 600; margin-top: 1rem; margin-bottom: 0.5rem; color: #4a5568; }
    .prose p { margin-bottom: 1rem; line-height: 1.6; color: #4a5568; }
    .prose ul, .prose ol { margin-left: 1.5rem; margin-bottom: 1rem; }
    .prose li { margin-bottom: 0.5rem; }
    .prose strong { font-weight: bold; color: #2d3748; }
    .prose code { background-color: #f7fafc; padding: 0.2rem 0.4rem; border-radius: 0.25rem; font-family: monospace; font-size: 0.875rem; }
    .prose pre { background-color: #2d3748; color: #e2e8f0; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; margin-bottom: 1rem; }
    .prose blockquote { border-left: 4px solid #cbd5e0; padding-left: 1rem; margin: 1rem 0; font-style: italic; color: #718096; }
    .prose table { width: 100%; border-collapse: collapse; margin-bottom: 1rem; }
    .prose th { background-color: #edf2f7; padding: 0.75rem; text-align: left; font-weight: bold; border: 1px solid #cbd5e0; }
    .prose td { padding: 0.75rem; border: 1px solid #e2e8f0; }
    
    /* Terminal Styling */
    .terminal-scroll::-webkit-scrollbar { width: 6px; }
    .terminal-scroll::-webkit-scrollbar-track { background: #0f172a; }
    .terminal-scroll::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
    
    .log-entry { 
        display: flex; 
        align-items: flex-start; 
        gap: 0.5rem; 
        padding: 0.25rem 0;
        animation: fadeIn 0.3s ease-in;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-5px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .timestamp { color: #64748b; min-width: 65px; }
    
    .log-info { color: #10b981; }
    .log-success { color: #10b981; font-weight: bold; }
    .log-error { color: #ef4444; font-weight: bold; }
    .log-warning { color: #f59e0b; font-weight: bold; }
    .log-scanning { 
        color: #3b82f6; 
        font-weight: bold;
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.6; }
    }
    
    .log-image-preview {
        display: inline-block;
        width: 40px;
        height: 40px;
        border-radius: 4px;
        border: 1px solid #334155;
        object-fit: cover;
        vertical-align: middle;
        margin-left: 8px;
        cursor: pointer;
        transition: transform 0.2s;
    }
    
    .log-image-preview:hover {
        transform: scale(3);
        z-index: 10;
        box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    }
    
    /* Graph notification animations */
    @keyframes slideIn {
        from { transform: translateX(400px); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(400px); opacity: 0; }
    }
</style>
{% endblock %}

{% block content %}
<!-- Tab Container: Investigation, Graph, Reports, Settings -->
<div id="investigationTab" class="flex-1 flex flex-col">
<!-- Header -->
<header class="bg-slate-950 border-b border-slate-800 px-8 py-4">
    <div class="flex items-center justify-between">
        <div>
            <h2 class="text-2xl font-bold text-white">Investigation</h2>
        </div>
    </div>
</header>

<!-- Main Content -->
<div class="flex-1 overflow-y-auto p-8">
    <div class="max-w-7xl mx-auto space-y-8">
        
        <!-- Hero Search Section -->
        <div class="bg-gradient-animated rounded-2xl p-8 glow-accent">
            <div class="text-center mb-6">
                <h3 class="text-3xl font-bold text-white mb-2">Enter Research Query</h3>
                <p class="text-gray-300">Analyze drugs, compounds, clinical trials, or biomedical topics</p>
            </div>
            
            <form id="queryForm" class="max-w-4xl mx-auto">
                <div class="flex gap-4">
                    <div class="flex-1 relative">
                        <input 
                            type="text" 
                            id="queryInput"
                            placeholder="e.g., 'Analyze pembrolizumab cardiotoxicity risks' or 'Evaluate CAR-T therapy safety profile'"
                            class="w-full px-6 py-4 bg-slate-800 border border-slate-700 rounded-xl text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent"
                            required
                        />
                        <div class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 text-sm">
                            <kbd class="px-2 py-1 bg-slate-700 rounded">Ctrl+Enter</kbd>
                        </div>
                    </div>
                    <button 
                        type="submit"
                        id="analyzeBtn"
                        class="px-8 py-4 bg-emerald-600 hover:bg-emerald-500 text-white font-semibold rounded-xl transition-all glow-safe hover:scale-105"
                    >
                        <span class="flex items-center space-x-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                            <span>Launch Analysis</span>
                        </span>
                    </button>
                </div>
            </form>
            
            <!-- Quick Examples -->
            <div class="mt-6 flex flex-wrap gap-2 justify-center">
                <span class="text-sm text-gray-400">Quick examples:</span>
                <button class="quick-query px-3 py-1 bg-slate-800/50 hover:bg-slate-700 rounded-lg text-sm text-emerald-400 transition-colors" data-query="Assess nivolumab hepatotoxicity in melanoma patients">
                    Nivolumab hepatotoxicity
                </button>
                <button class="quick-query px-3 py-1 bg-slate-800/50 hover:bg-slate-700 rounded-lg text-sm text-emerald-400 transition-colors" data-query="Evaluate CRISPR off-target effects in clinical trials">
                    CRISPR safety profile
                </button>
                <button class="quick-query px-3 py-1 bg-slate-800/50 hover:bg-slate-700 rounded-lg text-sm text-emerald-400 transition-colors" data-query="Analyze mRNA vaccine long-term immunogenicity">
                    mRNA vaccine efficacy
                </button>
            </div>
        </div>

        <!-- PDF Upload Section -->
        <div class="bg-slate-800 rounded-2xl p-8 border border-slate-700">
            <div class="flex items-start justify-between mb-6">
                <div>
                    <h3 class="text-xl font-bold text-white flex items-center gap-2">
                        <svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                        </svg>
                        Evidence Upload
                    </h3>
                    <p class="text-sm text-gray-400 mt-1">Drag & drop PDF documents for enhanced context</p>
                </div>
                <span class="px-3 py-1 bg-blue-500/20 text-blue-400 text-xs font-semibold rounded-full">Optional</span>
            </div>
            
            <div 
                id="dropZone"
                class="border-2 border-dashed border-slate-600 hover:border-emerald-500 rounded-xl p-12 text-center transition-all cursor-pointer bg-slate-900/50"
            >
                <svg class="w-16 h-16 mx-auto text-gray-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                <p class="text-gray-400 mb-2">Drop PDF files here or click to browse</p>
                <p class="text-sm text-gray-500">Supports: Clinical trial reports, Research papers, FDA documents</p>
                <input type="file" id="fileInput" multiple accept=".pdf" class="hidden">
            </div>
            
            <div id="fileList" class="mt-4 space-y-2"></div>
        </div>

        <!-- Workflow Progress -->
        <div id="progressSection" class="bg-slate-800 rounded-2xl p-8 border border-slate-700 hidden">
            <h3 class="text-xl font-bold text-white mb-6">Investigation Progress</h3>
            
            <!-- Step Stepper -->
            <div class="relative">
                <div class="absolute top-5 left-0 right-0 h-0.5 bg-slate-700"></div>
                <div id="progressBar" class="absolute top-5 left-0 h-0.5 bg-emerald-500 transition-all duration-500" style="width: 0%"></div>
                
                <div class="relative flex justify-between">
                    <!-- Step 1: BioHarvest -->
                    <div class="step-item flex flex-col items-center" data-step="harvest">
                        <div class="w-10 h-10 rounded-full bg-slate-700 border-2 border-slate-600 flex items-center justify-center mb-2 transition-all">
                            <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                        <span class="text-sm text-gray-400 font-medium">Harvesting</span>
                        <span class="text-xs text-gray-600 mt-1">PubMed + Trials</span>
                    </div>
                    
                    <!-- Step 2: Evidence Mining -->
                    <div class="step-item flex flex-col items-center" data-step="mining">
                        <div class="w-10 h-10 rounded-full bg-slate-700 border-2 border-slate-600 flex items-center justify-center mb-2 transition-all">
                            <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"></path>
                            </svg>
                        </div>
                        <span class="text-sm text-gray-400 font-medium">Mining</span>
                        <span class="text-xs text-gray-600 mt-1">Extract Evidence</span>
                    </div>
                    
                    <!-- Step 3: Forensic Audit -->
                    <div class="step-item flex flex-col items-center" data-step="auditing">
                        <div class="w-10 h-10 rounded-full bg-slate-700 border-2 border-slate-600 flex items-center justify-center mb-2 transition-all">
                            <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                            </svg>
                        </div>
                        <span class="text-sm text-gray-400 font-medium">Auditing</span>
                        <span class="text-xs text-gray-600 mt-1">Safety Review</span>
                    </div>
                    
                    <!-- Step 4: Report Writing -->
                    <div class="step-item flex flex-col items-center" data-step="writing">
                        <div class="w-10 h-10 rounded-full bg-slate-700 border-2 border-slate-600 flex items-center justify-center mb-2 transition-all">
                            <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                            </svg>
                        </div>
                        <span class="text-sm text-gray-400 font-medium">Writing</span>
                        <span class="text-xs text-gray-600 mt-1">Final Report</span>
                    </div>
                </div>
            </div>
            
            <!-- Live Logs -->
            <div class="mt-8">
                <div class="flex items-center justify-between mb-3">
                    <h4 class="text-sm font-semibold text-gray-300">Real-Time Terminal</h4>
                    <div class="flex items-center gap-2">
                        <div class="flex items-center gap-1">
                            <div class="w-2 h-2 bg-emerald-500 rounded-full pulse-safe"></div>
                            <span class="text-xs text-gray-500">Live</span>
                        </div>
                        <button id="clearLogs" class="text-xs text-gray-500 hover:text-gray-300 px-2 py-1 bg-slate-800 rounded">Clear</button>
                    </div>
                </div>
                <div id="logContainer" class="bg-slate-950 rounded-lg p-4 h-96 overflow-y-auto font-mono text-xs space-y-1 border border-slate-800 terminal-scroll">
                    <div class="log-entry text-gray-500">
                        <span class="timestamp">[00:00:00]</span> 
                        <span class="log-info">‚óè</span> 
                        <span>System ready. Waiting for analysis to start...</span>
                    </div>
                </div>
            </div>
            
            <!-- Results -->
            <div id="resultsSection" class="mt-6 hidden">
                <div class="bg-emerald-500/10 border border-emerald-500/30 rounded-xl p-6">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-2">
                                <svg class="w-6 h-6 text-emerald-400" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                </svg>
                                <h4 class="text-lg font-bold text-emerald-400">Analysis Complete</h4>
                            </div>
                            <p class="text-gray-300" id="completionMessage">Report generated successfully</p>
                        </div>
                        <a id="downloadBtn" href="#" download class="px-6 py-3 bg-emerald-600 hover:bg-emerald-500 text-white font-semibold rounded-lg transition-colors">
                            <span class="flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                Download PDF Report
                            </span>
                        </a>
                    </div>
                    
                    <!-- Full Report Viewer (Collapsible) -->
                    <div id="fullReportContainer" class="mt-6 hidden">
                        <button id="toggleReportBtn" class="w-full flex items-center justify-between px-4 py-3 bg-slate-800/50 hover:bg-slate-800 rounded-lg transition-colors border border-slate-700">
                            <span class="text-emerald-400 font-semibold">üìÑ View Complete Report</span>
                            <svg id="toggleIcon" class="w-5 h-5 text-gray-400 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        <div id="fullReportContent" class="hidden mt-4 bg-white rounded-lg p-8 shadow-lg overflow-y-auto max-h-[600px] prose prose-slate max-w-none">
                            <!-- Markdown will be rendered here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>
</div>
<!-- End Investigation Tab -->

<!-- Knowledge Graph Tab -->
<div id="graphTab" class="flex-1 flex flex-col hidden">
    <header class="bg-slate-950 border-b border-slate-800 px-8 py-4">
        <div class="flex items-center justify-between">
            <div>
                <h2 class="text-2xl font-bold text-white">üß† Global Knowledge Graph</h2>
                <p class="text-sm text-gray-400 mt-1">CassandraÁöÑÈïøÊúüËÆ∞ÂøÜ - Ëá™Âä®ÊûÑÂª∫ÁîüÁâ©ÂåªËçØÊ¨∫ËØàÁΩëÁªú</p>
            </div>
            <div class="flex items-center space-x-4">
                <div class="flex items-center space-x-2 px-4 py-2 bg-slate-800 rounded-lg">
                    <div class="w-2 h-2 bg-emerald-400 rounded-full pulse-safe"></div>
                    <span class="text-sm text-gray-300">Neo4j Connected</span>
                </div>
            </div>
        </div>
    </header>
    
    <div class="flex-1 p-8">
        <div id="graph-main-container" class="shadow-2xl border border-slate-700 rounded-2xl overflow-hidden" style="height: calc(100vh - 200px); position: relative; background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);">
            <!-- Graph will be rendered here by Force Graph library -->
        </div>
    </div>
</div>
<!-- End Graph Tab -->

<!-- Reports Tab -->
<div id="reportsTab" class="flex-1 flex flex-col hidden">
    <header class="bg-slate-950 border-b border-slate-800 px-8 py-4">
        <div>
            <h2 class="text-2xl font-bold text-white">Investigation Reports</h2>
            <p class="text-sm text-gray-400 mt-1">Browse all generated reports</p>
        </div>
    </header>
    <div class="flex-1 overflow-y-auto p-8">
        <div class="max-w-7xl mx-auto">
            <div id="reportsList" class="space-y-4">
                <div class="text-center text-gray-400 py-12">
                    <svg class="w-16 h-16 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <p class="text-lg">Loading reports...</p>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- End Reports Tab -->

<!-- Settings Tab -->
<div id="settingsTab" class="flex-1 flex flex-col hidden">
    <header class="bg-slate-950 border-b border-slate-800 px-8 py-4">
        <div>
            <h2 class="text-2xl font-bold text-white">System Settings</h2>
            <p class="text-sm text-gray-400 mt-1">Configure API keys and engines</p>
        </div>
    </header>
    <div class="flex-1 overflow-y-auto p-8">
        <div class="max-w-4xl mx-auto space-y-6">
            <div id="settingsContent" class="bg-slate-800 rounded-2xl p-8 border border-slate-700">
                <div class="text-center text-gray-400 py-12">
                    <svg class="w-16 h-16 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    <p class="text-lg">Loading settings...</p>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- End Settings Tab -->

{% endblock %}

{% block scripts %}
<script>
    // ===== SPA Tab Management Functions =====
    
    // Load Reports from final_reports directory
    async function loadReports() {
        const reportsList = document.getElementById('reportsList');
        reportsList.innerHTML = '<div class="text-center text-gray-400 py-8"><div class="animate-pulse">Loading reports...</div></div>';
        
        try {
            const response = await fetch('/api/reports/list');
            const data = await response.json();
            
            if (data.success && data.reports && data.reports.length > 0) {
                reportsList.innerHTML = data.reports.map(report => `
                    <div class="bg-slate-800 rounded-xl p-6 border border-slate-700 hover:border-emerald-500 transition-all">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <h3 class="text-lg font-semibold text-white mb-2">${report.title || report.filename}</h3>
                                <div class="flex items-center gap-4 text-sm text-gray-400 mb-3">
                                    <span>üìÖ ${new Date(report.timestamp).toLocaleString()}</span>
                                    <span>üìÑ ${(report.size / 1024).toFixed(1)} KB</span>
                                </div>
                                ${report.preview ? `<p class="text-gray-300 text-sm line-clamp-2">${report.preview}</p>` : ''}
                            </div>
                            <div class="flex gap-2 ml-4">
                                <a href="/api/reports/download/${report.filename}" 
                                   class="px-4 py-2 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg text-sm font-medium transition-colors">
                                    Download
                                </a>
                                <button onclick="viewReport('${report.filename}')" 
                                        class="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg text-sm font-medium transition-colors">
                                    View
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                reportsList.innerHTML = `
                    <div class="text-center text-gray-400 py-12">
                        <svg class="w-16 h-16 mx-auto mb-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <p class="text-lg">No reports found</p>
                        <p class="text-sm text-gray-500 mt-2">Run an investigation to generate your first report</p>
                    </div>
                `;
            }
        } catch (error) {
            console.error('Failed to load reports:', error);
            reportsList.innerHTML = `
                <div class="text-center text-red-400 py-12">
                    <p class="text-lg">Failed to load reports</p>
                    <p class="text-sm text-gray-500 mt-2">${error.message}</p>
                </div>
            `;
        }
    }
    
    // View report in modal or new page
    async function viewReport(filename) {
        window.open(`/api/reports/view/${filename}`, '_blank');
    }
    
    // ===== Knowledge Graph Visualization =====
    let graphInstance = null;
    let currentGraphData = null;
    
    // Show graph notification
    function showGraphNotification(message) {
        console.log(`üìä Graph: ${message}`);
        // You can add a toast notification here if desired
        // For now, just log to console
    }
    
    // Load drug-specific subgraph (Drill Down mode)
    async function loadDrugSubgraph(drugName) {
        console.log(`Loading subgraph for drug: ${drugName}...`);
        
        const container = document.getElementById('graph-main-container');
        if (!container) {
            console.error('Graph container not found');
            return;
        }
        
        // Show loading state
        container.innerHTML = `
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: #9ca3af;">
                <svg class="w-16 h-16 mx-auto mb-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                <p class="text-lg">Loading ${drugName} Subgraph...</p>
            </div>
        `;
        
        try {
            // Fetch drug-specific subgraph
            const response = await fetch(`/api/graph/drug/${encodeURIComponent(drugName)}`);
            const data = await response.json();
            
            if (data.success) {
                currentGraphData = data;
                renderKnowledgeGraph(container, data, true);  // true = drug mode
                
                // Show notification
                showGraphNotification(`Switched to ${drugName} focused view`);
            } else {
                throw new Error('Failed to load drug subgraph');
            }
        } catch (error) {
            console.error(`Failed to load ${drugName} subgraph:`, error);
            // Fallback to global graph
            loadGraph();
        }
    }
    
    // Load and initialize knowledge graph
    async function loadGraph() {
        console.log('Loading knowledge graph...');
        
        const container = document.getElementById('graph-main-container');
        if (!container) {
            console.error('Graph container not found');
            return;
        }
        
        // Show loading state
        container.innerHTML = `
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: #9ca3af;">
                <svg class="w-16 h-16 mx-auto mb-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                <p class="text-lg">Loading Global Knowledge Graph...</p>
            </div>
        `;
        
        try {
            // Fetch global graph data
            const response = await fetch('/api/graph/global');
            const data = await response.json();
            
            if (data.success) {
                currentGraphData = data;
                renderKnowledgeGraph(container, data);
            } else {
                throw new Error('Failed to load graph data');
            }
        } catch (error) {
            console.error('Failed to load knowledge graph:', error);
            container.innerHTML = `
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: #ef4444;">
                    <svg class="w-16 h-16 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <p class="text-lg">Failed to load knowledge graph</p>
                    <p class="text-sm text-gray-500 mt-2">${error.message}</p>
                </div>
            `;
        }
    }
    
    // Render knowledge graph using Force Graph
    function renderKnowledgeGraph(container, data, isDrugMode = false) {
        // Clear container
        container.innerHTML = '';
        
        const viewMode = isDrugMode ? `Drug: ${data.drug || 'Focused'}` : 'Global Brain';
        logger.info(`üìä Rendering graph - Mode: ${viewMode}, Nodes: ${data.nodes.length}, Links: ${data.links.length}`);
        
        // Add controls overlay
        const controlsHtml = `
            <div style="position: absolute; top: 20px; left: 20px; z-index: 10; display: flex; gap: 12px; flex-wrap: wrap;">
                <button onclick="resetGraphView()" style="padding: 12px 20px; background: rgba(15, 23, 42, 0.9); border: 1px solid #334155; color: white; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s; backdrop-filter: blur(10px);">
                    üîÑ Reset View
                </button>
                <button onclick="focusOnDrug()" style="padding: 12px 20px; background: rgba(15, 23, 42, 0.9); border: 1px solid #334155; color: white; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s; backdrop-filter: blur(10px);">
                    üíä Search Drug
                </button>
            </div>
            
            <div style="position: absolute; bottom: 20px; left: 20px; z-index: 10; padding: 16px 20px; background: rgba(15, 23, 42, 0.95); border: 1px solid #334155; border-radius: 12px; color: white; font-family: monospace; font-size: 13px; backdrop-filter: blur(10px);">
                <div style="display: flex; justify-content: space-between; gap: 20px; margin-bottom: 8px;">
                    <span style="color: #94a3b8;">Nodes:</span>
                    <span style="color: #10b981; font-weight: bold;">${data.nodes.length}</span>
                </div>
                <div style="display: flex; justify-content: space-between; gap: 20px; margin-bottom: 8px;">
                    <span style="color: #94a3b8;">Relationships:</span>
                    <span style="color: #10b981; font-weight: bold;">${data.links.length}</span>
                </div>
                <div style="display: flex; justify-content: space-between; gap: 20px;">
                    <span style="color: #94a3b8;">View Mode:</span>
                    <span style="color: #10b981; font-weight: bold;">${isDrugMode ? data.drug || 'Drug' : 'Global'}</span>
                </div>
            </div>
            
            <div style="position: absolute; top: 20px; right: 20px; z-index: 10; padding: 16px; background: rgba(15, 23, 42, 0.95); border: 1px solid #334155; border-radius: 12px; color: white; font-size: 12px; backdrop-filter: blur(10px); max-width: 200px;">
                <div style="font-weight: bold; margin-bottom: 12px; color: #10b981;">Node Types</div>
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                    <div style="width: 16px; height: 16px; border-radius: 50%; background: #ef4444;"></div>
                    <span>Drug</span>
                </div>
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                    <div style="width: 16px; height: 16px; border-radius: 50%; background: #f59e0b;"></div>
                    <span>Paper</span>
                </div>
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                    <div style="width: 16px; height: 16px; border-radius: 50%; background: #10b981;"></div>
                    <span>Author</span>
                </div>
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                    <div style="width: 16px; height: 16px; border-radius: 50%; background: #3b82f6;"></div>
                    <span>Clinical Trial</span>
                </div>
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                    <div style="width: 16px; height: 16px; border-radius: 50%; background: #8b5cf6;"></div>
                    <span>Adverse Event</span>
                </div>
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                    <div style="width: 16px; height: 16px; border-radius: 50%; background: #ec4899;"></div>
                    <span>Company</span>
                </div>
            </div>
        `;
        
        // Color mapping
        const nodeColors = {
            'Drug': '#ef4444',
            'Paper': '#f59e0b',
            'Author': '#10b981',
            'ClinicalTrial': '#3b82f6',
            'AdverseEvent': '#8b5cf6',
            'Company': '#ec4899',
            'RegulatoryWarning': '#dc2626',
            'Unknown': '#6b7280'
        };
        
        // Initialize Force Graph
        graphInstance = ForceGraph()(container)
            .graphData({
                nodes: data.nodes.map(n => ({...n})),
                links: data.links.map(l => ({...l}))
            })
            .nodeLabel(node => {
                const props = node.properties || {};
                let html = `<div style="background: rgba(15, 23, 42, 0.98); padding: 12px; border-radius: 8px; border: 1px solid #10b981; max-width: 300px;">`;
                html += `<div style="font-weight: bold; color: #10b981; margin-bottom: 8px; font-size: 15px;">${node.name}</div>`;
                html += `<div style="color: #94a3b8;">Type: ${node.label}</div>`;
                if (props.company) html += `<div style="color: #94a3b8;">Company: ${props.company}</div>`;
                if (props.suspicious) html += '<div style="color: #ef4444;">‚ö†Ô∏è Suspicious Activity</div>';
                if (props.retracted) html += '<div style="color: #ef4444;">üö´ Retracted</div>';
                html += '</div>';
                return html;
            })
            .nodeColor(node => {
                if (node.isDrugCenter) return '#fbbf24';
                if (node.properties && node.properties.suspicious) return '#ef4444';
                return nodeColors[node.label] || nodeColors['Unknown'];
            })
            .nodeVal(node => node.isDrugCenter ? 20 : (node.properties && node.properties.suspicious ? 12 : 8))
            .linkColor(() => '#475569')
            .linkWidth(2)
            .linkDirectionalParticles(2)
            .linkDirectionalParticleSpeed(0.005)
            .onNodeClick(node => {
                console.log('Clicked node:', node);
                // Could implement drill-down to specific drug
            })
            .d3Force('charge').strength(-200);
        
        // Insert controls
        container.insertAdjacentHTML('beforeend', controlsHtml);
    }
    
    function resetGraphView() {
        if (graphInstance) {
            graphInstance.zoomToFit(400);
        }
    }
    
    function focusOnDrug() {
        const drugName = prompt('Enter drug name (e.g., Simufilam, Pembrolizumab):');
        if (!drugName) return;
        
        fetch(`/api/graph/drug/${encodeURIComponent(drugName)}`)
            .then(res => res.json())
            .then(data => {
                if (data.success && graphInstance) {
                    graphInstance.graphData({
                        nodes: data.nodes.map(n => ({...n})),
                        links: data.links.map(l => ({...l}))
                    });
                    graphInstance.zoomToFit(400);
                } else {
                    alert('Drug not found in knowledge graph');
                }
            })
            .catch(err => {
                console.error('Failed to load drug graph:', err);
                alert('Failed to load drug data');
            });
    }
    
    function showGraphNotification(message) {
        const toast = document.createElement('div');
        toast.style.cssText = `
            position: fixed;
            top: 100px;
            right: 20px;
            padding: 16px 20px;
            background: rgba(16, 185, 129, 0.95);
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        `;
        toast.textContent = `‚ú® ${message}`;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.style.animation = 'slideOut 0.3s ease-out';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }
    
    // Load Knowledge Graph
    function loadGraph() {
        // Will implement with Neovis.js in next step
        console.log('Loading knowledge graph...');
    }
    
    // Load Settings
    async function loadSettings() {
        const settingsContent = document.getElementById('settingsContent');
        settingsContent.innerHTML = '<div class="text-center text-gray-400 py-8"><div class="animate-pulse">Loading settings...</div></div>';
        
        try {
            const response = await fetch('/api/get-config');
            const config = await response.json();
            
            settingsContent.innerHTML = `
                <form id="settingsForm" class="space-y-6">
                    <!-- Gemini API Settings -->
                    <div class="border-b border-slate-700 pb-6">
                        <h3 class="text-xl font-semibold text-white mb-4">ü§ñ Gemini AI Configuration</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">API Key</label>
                                <input type="password" name="gemini_api_key" placeholder="AIza..." 
                                       class="w-full px-4 py-2 bg-slate-900 border border-slate-700 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-emerald-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Model</label>
                                <input type="text" name="gemini_model" value="${config.gemini?.model || 'gemini-1.5-pro'}" 
                                       class="w-full px-4 py-2 bg-slate-900 border border-slate-700 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-emerald-500">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Temperature</label>
                                    <input type="number" name="gemini_temperature" value="${config.gemini?.temperature || 0.7}" step="0.1" min="0" max="1"
                                           class="w-full px-4 py-2 bg-slate-900 border border-slate-700 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-emerald-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Max Tokens</label>
                                    <input type="number" name="gemini_max_tokens" value="${config.gemini?.max_tokens || 8192}"
                                           class="w-full px-4 py-2 bg-slate-900 border border-slate-700 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-emerald-500">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Neo4j Settings -->
                    <div class="border-b border-slate-700 pb-6">
                        <h3 class="text-xl font-semibold text-white mb-4">üóÑÔ∏è Neo4j Database</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">URI</label>
                                <input type="text" name="neo4j_uri" value="${config.neo4j?.uri || 'bolt://localhost:7687'}"
                                       class="w-full px-4 py-2 bg-slate-900 border border-slate-700 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-emerald-500">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Username</label>
                                    <input type="text" name="neo4j_user" value="${config.neo4j?.user || 'neo4j'}"
                                           class="w-full px-4 py-2 bg-slate-900 border border-slate-700 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-emerald-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Password</label>
                                    <input type="password" name="neo4j_password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                                           class="w-full px-4 py-2 bg-slate-900 border border-slate-700 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-emerald-500">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Save Button -->
                    <div class="flex justify-end gap-4">
                        <button type="button" onclick="testConnections()" 
                                class="px-6 py-3 bg-slate-700 hover:bg-slate-600 text-white font-semibold rounded-lg transition-colors">
                            Test Connections
                        </button>
                        <button type="submit" 
                                class="px-6 py-3 bg-emerald-600 hover:bg-emerald-500 text-white font-semibold rounded-lg transition-colors">
                            Save Settings
                        </button>
                    </div>
                </form>
                
                <div id="settingsStatus" class="mt-4 hidden"></div>
            `;
            
            // Add form submission handler
            document.getElementById('settingsForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await saveSettings(new FormData(e.target));
            });
            
        } catch (error) {
            console.error('Failed to load settings:', error);
            settingsContent.innerHTML = `
                <div class="text-center text-red-400 py-12">
                    <p class="text-lg">Failed to load settings</p>
                    <p class="text-sm text-gray-500 mt-2">${error.message}</p>
                </div>
            `;
        }
    }
    
    // Save settings
    async function saveSettings(formData) {
        const statusDiv = document.getElementById('settingsStatus');
        statusDiv.classList.remove('hidden');
        statusDiv.innerHTML = '<div class="text-gray-400">Saving settings...</div>';
        
        try {
            const config = {
                gemini: {
                    api_key: formData.get('gemini_api_key'),
                    model: formData.get('gemini_model'),
                    temperature: parseFloat(formData.get('gemini_temperature')),
                    max_tokens: parseInt(formData.get('gemini_max_tokens'))
                },
                neo4j: {
                    uri: formData.get('neo4j_uri'),
                    user: formData.get('neo4j_user'),
                    password: formData.get('neo4j_password')
                }
            };
            
            const response = await fetch('/api/save-config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(config)
            });
            
            const result = await response.json();
            
            if (result.success) {
                statusDiv.innerHTML = '<div class="text-emerald-400 p-4 bg-emerald-950/40 rounded-lg">‚úì Settings saved successfully!</div>';
            } else {
                statusDiv.innerHTML = `<div class="text-red-400 p-4 bg-red-950/40 rounded-lg">‚úó Failed to save: ${result.error}</div>`;
            }
        } catch (error) {
            statusDiv.innerHTML = `<div class="text-red-400 p-4 bg-red-950/40 rounded-lg">‚úó Error: ${error.message}</div>`;
        }
    }
    
    // Test connections
    async function testConnections() {
        const statusDiv = document.getElementById('settingsStatus');
        statusDiv.classList.remove('hidden');
        statusDiv.innerHTML = '<div class="text-gray-400">Testing connections...</div>';
        
        // Simple test - will enhance later
        statusDiv.innerHTML = '<div class="text-blue-400 p-4 bg-blue-950/40 rounded-lg">Connection test feature coming soon...</div>';
    }
    
    // ===== PHASE 3.2: SPA Functionality & localStorage Persistence =====
    
    // Function to show Reports tab (called from sidebar)
    function showReportsTab() {
        const lastReport = localStorage.getItem('last_report');
        if (lastReport) {
            try {
                const reportData = JSON.parse(lastReport);
                // Restore the report view
                restoreReportFromStorage(reportData);
                // Scroll to results
                document.getElementById('resultsSection')?.scrollIntoView({ behavior: 'smooth' });
            } catch (e) {
                console.error('Failed to parse stored report:', e);
                alert('No recent report found in cache. Please run a new analysis.');
            }
        } else {
            alert('No recent report found. Please run an analysis first.');
        }
    }
    
    // Function to restore report from localStorage
    function restoreReportFromStorage(reportData) {
        const resultsSection = document.getElementById('resultsSection');
        resultsSection.classList.remove('hidden');
        
        const summary = reportData.summary || {};
        const executiveSummary = reportData.executive_summary || '';
        
        // Rebuild the summary HTML (same logic as socket handler)
        let summaryHTML = '';
        
        if (executiveSummary && executiveSummary.length > 50) {
            const riskLevel = executiveSummary.toLowerCase().includes('high risk') ? 'HIGH RISK' :
                             executiveSummary.toLowerCase().includes('medium risk') ? 'MEDIUM RISK' :
                             executiveSummary.toLowerCase().includes('avoid') ? 'CAUTION' : 'ANALYSIS';
            
            const riskColor = riskLevel === 'HIGH RISK' ? 'text-red-400' :
                             riskLevel === 'MEDIUM RISK' ? 'text-yellow-400' :
                             riskLevel === 'CAUTION' ? 'text-orange-400' : 'text-emerald-400';
            
            const riskBg = riskLevel === 'HIGH RISK' ? 'bg-red-950/40 border-red-800/50' :
                          riskLevel === 'MEDIUM RISK' ? 'bg-yellow-950/40 border-yellow-800/50' :
                          riskLevel === 'CAUTION' ? 'bg-orange-950/40 border-orange-800/50' : 'bg-emerald-950/40 border-emerald-800/50';
            
            summaryHTML = `
                <div class="${riskBg} rounded-xl p-6 border-2 mb-4 font-mono">
                    <div class="flex items-start gap-4">
                        <div class="flex-shrink-0 mt-1">
                            <svg class="w-8 h-8 ${riskColor}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-3">
                                <span class="${riskColor} font-bold text-lg tracking-wider">[${riskLevel} DETECTED]</span>
                                <span class="text-gray-500 text-sm">// Strategic Assessment (Restored)</span>
                            </div>
                            <div class="text-gray-300 leading-relaxed whitespace-pre-wrap">${executiveSummary}</div>
                            <div class="mt-4 pt-4 border-t border-slate-700/50 flex items-center justify-between text-sm">
                                <div class="flex gap-4 text-gray-500">
                                    <span>üìä ${summary.harvested_items || 0} sources</span>
                                    <span>üîç ${summary.text_evidence || 0} evidence</span>
                                    <span>üñºÔ∏è ${summary.forensic_evidence || 0} forensics</span>
                                </div>
                                <button onclick="document.getElementById('downloadBtn').click()" class="text-emerald-400 hover:text-emerald-300 font-semibold">Read Full Report ‚Üí</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        } else {
            summaryHTML = '<div class="text-gray-400 text-center p-4">Report summary unavailable</div>';
        }
        
        document.getElementById('completionMessage').innerHTML = summaryHTML;
        
        // Restore full report if available
        const fullMarkdown = reportData.full_report_markdown || '';
        if (fullMarkdown && typeof marked !== 'undefined') {
            const reportContainer = document.getElementById('fullReportContainer');
            const reportContent = document.getElementById('fullReportContent');
            
            reportContainer.classList.remove('hidden');
            reportContent.innerHTML = marked.parse(fullMarkdown);
        }
    }
    
    // On page load, check for stored report
    window.addEventListener('DOMContentLoaded', () => {
        const lastReport = localStorage.getItem('last_report');
        if (lastReport) {
            console.log('Found cached report, available via Reports tab');
        }
    });
    
    // ===== End Phase 3.2 Functions =====
    
    // Quick query buttons
    document.querySelectorAll('.quick-query').forEach(btn => {
        btn.addEventListener('click', () => {
            document.getElementById('queryInput').value = btn.dataset.query;
        });
    });
    
    // Keyboard shortcut
    document.getElementById('queryInput').addEventListener('keydown', (e) => {
        if (e.ctrlKey && e.key === 'Enter') {
            document.getElementById('queryForm').dispatchEvent(new Event('submit'));
        }
    });
    
    // File upload handling
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const fileList = document.getElementById('fileList');
    let uploadedFiles = [];
    
    dropZone.addEventListener('click', () => fileInput.click());
    
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('border-emerald-500', 'bg-emerald-500/5');
    });
    
    dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('border-emerald-500', 'bg-emerald-500/5');
    });
    
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('border-emerald-500', 'bg-emerald-500/5');
        handleFiles(e.dataTransfer.files);
    });
    
    fileInput.addEventListener('change', (e) => {
        handleFiles(e.target.files);
    });
    
    function handleFiles(files) {
        Array.from(files).forEach(file => {
            if (file.type === 'application/pdf') {
                uploadedFiles.push(file);
                addFileToList(file);
            }
        });
    }
    
    function addFileToList(file) {
        const fileItem = document.createElement('div');
        fileItem.className = 'flex items-center justify-between bg-slate-900 rounded-lg p-3';
        fileItem.innerHTML = `
            <div class="flex items-center gap-3">
                <svg class="w-5 h-5 text-red-400" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd"></path>
                </svg>
                <div>
                    <p class="text-sm text-white font-medium">${file.name}</p>
                    <p class="text-xs text-gray-500">${(file.size / 1024 / 1024).toFixed(2)} MB</p>
                </div>
            </div>
            <button class="remove-file text-gray-500 hover:text-red-400" data-name="${file.name}">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        `;
        fileList.appendChild(fileItem);
        
        fileItem.querySelector('.remove-file').addEventListener('click', () => {
            uploadedFiles = uploadedFiles.filter(f => f.name !== file.name);
            fileItem.remove();
        });
    }
    
    // Form submission
    document.getElementById('queryForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const query = document.getElementById('queryInput').value;
        const progressSection = document.getElementById('progressSection');
        const logContainer = document.getElementById('logContainer');
        const resultsSection = document.getElementById('resultsSection');
        
        // Show progress section
        progressSection.classList.remove('hidden');
        resultsSection.classList.add('hidden');
        logContainer.innerHTML = '';
        
        // Disable submit button
        const analyzeBtn = document.getElementById('analyzeBtn');
        analyzeBtn.disabled = true;
        analyzeBtn.innerHTML = '<span class="flex items-center gap-2"><svg class="animate-spin w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>Analyzing...</span></span>';
        
        // üî• Auto-switch to drug-specific subgraph when analysis starts
        const drugMatch = query.match(/(?:analyze|assess|evaluate|investigate)\s+(\w+)/i);
        if (drugMatch && typeof loadDrugSubgraph === 'function') {
            const drugName = drugMatch[1];
            console.log(`üéØ Switching to ${drugName} subgraph...`);
            setTimeout(() => loadDrugSubgraph(drugName), 1000);  // Slight delay for UX
        }
        
        // Start analysis
        try {
            const formData = new FormData();
            formData.append('query', query);
            uploadedFiles.forEach(file => formData.append('files', file));
            
            const response = await fetch('/api/analyze', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (!response.ok) {
                throw new Error(result.message || 'Analysis failed');
            }
            
            // Show that analysis has started (202 Accepted)
            if (response.status === 202) {
                addLog('success', `‚úì ${result.message}`);
                addLog('info', `Query: ${result.query}`);
                // Analysis will continue in background, WebSocket will handle updates
            } else {
                // Immediate success (synchronous response)
                resultsSection.classList.remove('hidden');
                document.getElementById('completionMessage').textContent = 
                    `Generated ${result.sections || 4} sections with ${result.evidence_count || 0} evidence items`;
                document.getElementById('downloadBtn').href = result.report_url || '#';
            }
            
        } catch (error) {
            addLog('error', `‚úó Error: ${error.message}`);
        } finally {
            // Keep button disabled until WebSocket signals completion
            // analyzeBtn.disabled = false;
            // analyzeBtn.innerHTML = '<span class="flex items-center space-x-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg><span>Launch Analysis</span></span>';
        }
    });
    
    // Step progress tracking
    function updateStep(step, status) {
        const stepEl = document.querySelector(`[data-step="${step}"]`);
        if (!stepEl) return;
        const circle = stepEl.querySelector('div');
        const svg = circle.querySelector('svg');
        
        if (status === 'active') {
            circle.className = 'w-10 h-10 rounded-full bg-emerald-600 border-2 border-emerald-400 flex items-center justify-center mb-2 pulse-safe';
            if (svg) {
                svg.classList.remove('text-gray-500');
                svg.classList.add('text-white');
            }
        } else if (status === 'complete') {
            circle.className = 'w-10 h-10 rounded-full bg-emerald-600 border-2 border-emerald-400 flex items-center justify-center mb-2';
            circle.innerHTML = '<svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>';
        }
        
        // Update progress bar
        const steps = ['harvest', 'mining', 'auditing', 'writing'];
        const currentIndex = steps.indexOf(step);
        const progress = ((currentIndex + 1) / steps.length) * 100;
        document.getElementById('progressBar').style.width = `${progress}%`;
    }
    
    // Enhanced log system with image support
    function addLog(type, message, imagePath = null) {
        const logContainer = document.getElementById('logContainer');
        const logEntry = document.createElement('div');
        logEntry.className = 'log-entry';
        
        const timestamp = new Date().toLocaleTimeString();
        
        let icon = '‚óè';
        let levelClass = 'log-info';
        let levelText = 'INFO';
        
        if (type === 'success') {
            icon = '‚úì';
            levelClass = 'log-success';
            levelText = 'SUCCESS';
        } else if (type === 'error') {
            icon = '‚úó';
            levelClass = 'log-error';
            levelText = 'ERROR';
        } else if (type === 'warning') {
            icon = '‚ö†';
            levelClass = 'log-warning';
            levelText = 'WARNING';
        } else if (type === 'scanning') {
            icon = 'üîç';
            levelClass = 'log-scanning';
            levelText = 'SCANNING';
        }
        
        let imageHtml = '';
        if (imagePath) {
            imageHtml = `<img src="${imagePath}" class="log-image-preview" alt="Scanning" title="Click to enlarge" />`;
        }
        
        logEntry.innerHTML = `
            <span class="timestamp">[${timestamp}]</span>
            <span class="${levelClass}">[${levelText}]</span>
            <span class="text-gray-300 flex-1">${message}${imageHtml}</span>
        `;
        
        logContainer.appendChild(logEntry);
        logContainer.scrollTop = logContainer.scrollHeight;
        
        // Auto-remove old logs if too many (keep last 200)
        const logs = logContainer.querySelectorAll('.log-entry');
        if (logs.length > 200) {
            logs[0].remove();
        }
    }
    
    document.getElementById('clearLogs').addEventListener('click', () => {
        document.getElementById('logContainer').innerHTML = `
            <div class="log-entry text-gray-500">
                <span class="timestamp">[${new Date().toLocaleTimeString()}]</span> 
                <span class="log-info">‚óè</span> 
                <span>Logs cleared. Ready for new analysis...</span>
            </div>
        `;
    });
    
    // Socket.IO for real-time updates (if available)
    if (typeof io !== 'undefined') {
        const socket = io();
        
        socket.on('log', (data) => {
            // Enhanced log handler with image support
            const level = data.level || 'info';
            const message = data.message || '';
            const imagePath = data.image_path || data.imagePath || null;
            
            // Map level names
            let logType = level.toLowerCase();
            if (logType === 'forensic' || logType === 'scan' || message.includes('Scanning')) {
                logType = 'scanning';
            }
            
            addLog(logType, message, imagePath);
        });
        
        socket.on('step', (data) => {
            updateStep(data.step, data.status);
        });
        
        // üî• Real-time knowledge graph updates
        socket.on('graph_update', (update) => {
            console.log('üìä Graph update received:', update);
            
            // Show notification
            if (update.type === 'node') {
                showGraphNotification(`New ${update.data.label} discovered: ${update.data.name}`);
            }
            
            // Update graph if it's currently visible
            if (graphInstance && currentGraphData) {
                if (update.type === 'node') {
                    // Check if node already exists
                    const exists = currentGraphData.nodes.find(n => n.id === update.data.id);
                    if (!exists) {
                        currentGraphData.nodes.push(update.data);
                        graphInstance.graphData(currentGraphData);
                    }
                } else if (update.type === 'relationship') {
                    // Check if relationship already exists
                    const exists = currentGraphData.links.find(l => 
                        l.source === update.data.source && l.target === update.data.target
                    );
                    if (!exists) {
                        currentGraphData.links.push(update.data);
                        graphInstance.graphData(currentGraphData);
                    }
                }
            }
        });
        
        socket.on('analysis_complete', (data) => {
            // PHASE 3.2 FIX: Save report to localStorage immediately to prevent data loss
            const reportData = {
                timestamp: new Date().toISOString(),
                executive_summary: data.executive_summary || '',
                full_report_markdown: data.full_report_markdown || '',
                summary: data.summary || {},
                report_path: data.report_path
            };
            localStorage.setItem('last_report', JSON.stringify(reportData));
            
            // Show completion
            const resultsSection = document.getElementById('resultsSection');
            resultsSection.classList.remove('hidden');
            
            const summary = data.summary || {};
            const executiveSummary = data.executive_summary || '';
            
            // Text-First Intelligence Card Design
            let summaryHTML = '';
            
            if (executiveSummary && executiveSummary.length > 50) {
                // PRIMARY: Show AI analysis with Terminal aesthetic
                const riskLevel = executiveSummary.toLowerCase().includes('high risk') ? 'HIGH RISK' :
                                 executiveSummary.toLowerCase().includes('medium risk') ? 'MEDIUM RISK' :
                                 executiveSummary.toLowerCase().includes('avoid') ? 'CAUTION' : 'ANALYSIS';
                
                const riskColor = riskLevel === 'HIGH RISK' ? 'text-red-400' :
                                 riskLevel === 'MEDIUM RISK' ? 'text-yellow-400' :
                                 riskLevel === 'CAUTION' ? 'text-orange-400' : 'text-emerald-400';
                
                const riskBg = riskLevel === 'HIGH RISK' ? 'bg-red-950/40 border-red-800/50' :
                              riskLevel === 'MEDIUM RISK' ? 'bg-yellow-950/40 border-yellow-800/50' :
                              riskLevel === 'CAUTION' ? 'bg-orange-950/40 border-orange-800/50' : 'bg-emerald-950/40 border-emerald-800/50';
                
                summaryHTML = `
                    <!-- Strategic Intelligence Card -->
                    <div class="${riskBg} rounded-xl p-6 border-2 mb-4 font-mono">
                        <div class="flex items-start gap-4">
                            <div class="flex-shrink-0 mt-1">
                                <svg class="w-8 h-8 ${riskColor}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <div class="flex items-center gap-3 mb-3">
                                    <span class="${riskColor} font-bold text-lg tracking-wider">[${riskLevel} DETECTED]</span>
                                    <span class="text-gray-500 text-sm">// Strategic Assessment</span>
                                </div>
                                <div class="text-gray-300 leading-relaxed whitespace-pre-wrap">${executiveSummary}</div>
                                <div class="mt-4 pt-4 border-t border-slate-700/50 flex items-center justify-between text-sm">
                                    <div class="flex gap-4 text-gray-500">
                                        <span>üìä ${summary.harvested_items || 0} sources</span>
                                        <span>üîç ${summary.text_evidence || 0} evidence</span>
                                        <span>üñºÔ∏è ${summary.forensic_evidence || 0} forensics</span>
                                    </div>
                                    <button onclick="document.getElementById('downloadBtn').click()" class="text-emerald-400 hover:text-emerald-300 font-semibold">Read Full Report ‚Üí</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                // FALLBACK: Show stats-only view if no executive summary
                summaryHTML = `
                    <div class="bg-slate-800/50 rounded-xl p-6 border border-slate-700">
                        <div class="text-center">
                            <div class="text-emerald-400 font-bold text-xl mb-3">‚úÖ Analysis Complete</div>
                            <div class="grid grid-cols-3 gap-4 text-center mt-4">
                                <div class="bg-slate-900/50 rounded-lg p-4">
                                    <div class="text-3xl font-bold text-white">${summary.harvested_items || 0}</div>
                                    <div class="text-sm text-gray-400 mt-1">Papers/Trials</div>
                                </div>
                                <div class="bg-slate-900/50 rounded-lg p-4">
                                    <div class="text-3xl font-bold text-white">${summary.text_evidence || 0}</div>
                                    <div class="text-sm text-gray-400 mt-1">Evidence Items</div>
                                </div>
                                <div class="bg-slate-900/50 rounded-lg p-4">
                                    <div class="text-3xl font-bold text-white">${summary.forensic_evidence || 0}</div>
                                    <div class="text-sm text-gray-400 mt-1">Forensic Findings</div>
                                </div>
                            </div>
                            <p class="text-gray-400 mt-4">üìÑ Full report ready for download below</p>
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('completionMessage').innerHTML = summaryHTML;
            
            // Render full report in viewer (if available)
            const fullMarkdown = data.full_report_markdown || '';
            if (fullMarkdown && typeof marked !== 'undefined') {
                const reportContainer = document.getElementById('fullReportContainer');
                const reportContent = document.getElementById('fullReportContent');
                const toggleBtn = document.getElementById('toggleReportBtn');
                const toggleIcon = document.getElementById('toggleIcon');
                
                reportContainer.classList.remove('hidden');
                
                // Render Markdown to HTML
                reportContent.innerHTML = marked.parse(fullMarkdown);
                
                // Toggle functionality
                toggleBtn.addEventListener('click', () => {
                    reportContent.classList.toggle('hidden');
                    toggleIcon.classList.toggle('rotate-180');
                });
            }
            
            // Enable download button
            const downloadBtn = document.getElementById('downloadBtn');
            if (data.report_path) {
                downloadBtn.href = `/api/reports/latest?format=pdf`;
                downloadBtn.onclick = async (e) => {
                    e.preventDefault();
                    window.location.href = `/api/reports/latest?format=pdf`;
                };
            }
            
            // Re-enable analyze button
            const analyzeBtn = document.getElementById('analyzeBtn');
            analyzeBtn.disabled = false;
            analyzeBtn.innerHTML = '<span class="flex items-center space-x-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg><span>Launch Analysis</span></span>';
            
            addLog('success', '‚úÖ Strategic assessment complete!');
        });
        
        socket.on('analysis_error', (data) => {
            addLog('error', `‚úó Analysis failed: ${data.error}`);
            
            // Re-enable analyze button
            const analyzeBtn = document.getElementById('analyzeBtn');
            analyzeBtn.disabled = false;
            analyzeBtn.innerHTML = '<span class="flex items-center space-x-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg><span>Launch Analysis</span></span>';
        });
    }
</script>
{% endblock %}
