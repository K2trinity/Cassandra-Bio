{% extends "base.html" %}

{% block title %}Mission Control - Cassandra{% endblock %}

{% block head %}
<!-- Marked.js for Markdown Rendering -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<style>
    /* Markdown Styling */
    .prose h1 { font-size: 2rem; font-weight: bold; margin-top: 1.5rem; margin-bottom: 1rem; color: #1a202c; }
    .prose h2 { font-size: 1.5rem; font-weight: bold; margin-top: 1.25rem; margin-bottom: 0.75rem; color: #2d3748; border-bottom: 2px solid #e2e8f0; padding-bottom: 0.5rem; }
    .prose h3 { font-size: 1.25rem; font-weight: 600; margin-top: 1rem; margin-bottom: 0.5rem; color: #4a5568; }
    .prose p { margin-bottom: 1rem; line-height: 1.6; color: #4a5568; }
    .prose ul, .prose ol { margin-left: 1.5rem; margin-bottom: 1rem; }
    .prose li { margin-bottom: 0.5rem; }
    .prose strong { font-weight: bold; color: #2d3748; }
    .prose code { background-color: #f7fafc; padding: 0.2rem 0.4rem; border-radius: 0.25rem; font-family: monospace; font-size: 0.875rem; }
    .prose pre { background-color: #2d3748; color: #e2e8f0; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; margin-bottom: 1rem; }
    .prose blockquote { border-left: 4px solid #cbd5e0; padding-left: 1rem; margin: 1rem 0; font-style: italic; color: #718096; }
    .prose table { width: 100%; border-collapse: collapse; margin-bottom: 1rem; }
    .prose th { background-color: #edf2f7; padding: 0.75rem; text-align: left; font-weight: bold; border: 1px solid #cbd5e0; }
    .prose td { padding: 0.75rem; border: 1px solid #e2e8f0; }
</style>
{% endblock %}

{% block content %}
<!-- Header -->
<header class="bg-slate-950 border-b border-slate-800 px-8 py-4">
    <div class="flex items-center justify-between">
        <div>
            <h2 class="text-2xl font-bold text-white">Mission Control</h2>
            <p class="text-sm text-gray-400 mt-1">Initiate biomedical due diligence investigations</p>
        </div>
        <div class="flex items-center space-x-4">
            <div class="flex items-center space-x-2 px-4 py-2 bg-slate-800 rounded-lg">
                <svg class="w-4 h-4 text-emerald-400" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                </svg>
                <span class="text-sm text-gray-300">4 Engines Ready</span>
            </div>
            <div class="px-4 py-2 bg-slate-800 rounded-lg text-sm text-gray-300 font-mono">
                Gemini 1.5 Pro
            </div>
        </div>
    </div>
</header>

<!-- Main Content -->
<div class="flex-1 overflow-y-auto p-8">
    <div class="max-w-7xl mx-auto space-y-8">
        
        <!-- Hero Search Section -->
        <div class="bg-gradient-animated rounded-2xl p-8 glow-accent">
            <div class="text-center mb-6">
                <h3 class="text-3xl font-bold text-white mb-2">Enter Research Query</h3>
                <p class="text-gray-300">Analyze drugs, compounds, clinical trials, or biomedical topics</p>
            </div>
            
            <form id="queryForm" class="max-w-4xl mx-auto">
                <div class="flex gap-4">
                    <div class="flex-1 relative">
                        <input 
                            type="text" 
                            id="queryInput"
                            placeholder="e.g., 'Analyze pembrolizumab cardiotoxicity risks' or 'Evaluate CAR-T therapy safety profile'"
                            class="w-full px-6 py-4 bg-slate-800 border border-slate-700 rounded-xl text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent"
                            required
                        />
                        <div class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 text-sm">
                            <kbd class="px-2 py-1 bg-slate-700 rounded">Ctrl+Enter</kbd>
                        </div>
                    </div>
                    <button 
                        type="submit"
                        id="analyzeBtn"
                        class="px-8 py-4 bg-emerald-600 hover:bg-emerald-500 text-white font-semibold rounded-xl transition-all glow-safe hover:scale-105"
                    >
                        <span class="flex items-center space-x-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                            <span>Launch Analysis</span>
                        </span>
                    </button>
                </div>
            </form>
            
            <!-- Quick Examples -->
            <div class="mt-6 flex flex-wrap gap-2 justify-center">
                <span class="text-sm text-gray-400">Quick examples:</span>
                <button class="quick-query px-3 py-1 bg-slate-800/50 hover:bg-slate-700 rounded-lg text-sm text-emerald-400 transition-colors" data-query="Assess nivolumab hepatotoxicity in melanoma patients">
                    Nivolumab hepatotoxicity
                </button>
                <button class="quick-query px-3 py-1 bg-slate-800/50 hover:bg-slate-700 rounded-lg text-sm text-emerald-400 transition-colors" data-query="Evaluate CRISPR off-target effects in clinical trials">
                    CRISPR safety profile
                </button>
                <button class="quick-query px-3 py-1 bg-slate-800/50 hover:bg-slate-700 rounded-lg text-sm text-emerald-400 transition-colors" data-query="Analyze mRNA vaccine long-term immunogenicity">
                    mRNA vaccine efficacy
                </button>
            </div>
        </div>

        <!-- PDF Upload Section -->
        <div class="bg-slate-800 rounded-2xl p-8 border border-slate-700">
            <div class="flex items-start justify-between mb-6">
                <div>
                    <h3 class="text-xl font-bold text-white flex items-center gap-2">
                        <svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                        </svg>
                        Evidence Upload
                    </h3>
                    <p class="text-sm text-gray-400 mt-1">Drag & drop PDF documents for enhanced context</p>
                </div>
                <span class="px-3 py-1 bg-blue-500/20 text-blue-400 text-xs font-semibold rounded-full">Optional</span>
            </div>
            
            <div 
                id="dropZone"
                class="border-2 border-dashed border-slate-600 hover:border-emerald-500 rounded-xl p-12 text-center transition-all cursor-pointer bg-slate-900/50"
            >
                <svg class="w-16 h-16 mx-auto text-gray-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                <p class="text-gray-400 mb-2">Drop PDF files here or click to browse</p>
                <p class="text-sm text-gray-500">Supports: Clinical trial reports, Research papers, FDA documents</p>
                <input type="file" id="fileInput" multiple accept=".pdf" class="hidden">
            </div>
            
            <div id="fileList" class="mt-4 space-y-2"></div>
        </div>

        <!-- Workflow Progress -->
        <div id="progressSection" class="bg-slate-800 rounded-2xl p-8 border border-slate-700 hidden">
            <h3 class="text-xl font-bold text-white mb-6">Investigation Progress</h3>
            
            <!-- Step Stepper -->
            <div class="relative">
                <div class="absolute top-5 left-0 right-0 h-0.5 bg-slate-700"></div>
                <div id="progressBar" class="absolute top-5 left-0 h-0.5 bg-emerald-500 transition-all duration-500" style="width: 0%"></div>
                
                <div class="relative flex justify-between">
                    <!-- Step 1: BioHarvest -->
                    <div class="step-item flex flex-col items-center" data-step="harvest">
                        <div class="w-10 h-10 rounded-full bg-slate-700 border-2 border-slate-600 flex items-center justify-center mb-2 transition-all">
                            <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                        <span class="text-sm text-gray-400 font-medium">Harvesting</span>
                        <span class="text-xs text-gray-600 mt-1">PubMed + Trials</span>
                    </div>
                    
                    <!-- Step 2: Evidence Mining -->
                    <div class="step-item flex flex-col items-center" data-step="mining">
                        <div class="w-10 h-10 rounded-full bg-slate-700 border-2 border-slate-600 flex items-center justify-center mb-2 transition-all">
                            <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"></path>
                            </svg>
                        </div>
                        <span class="text-sm text-gray-400 font-medium">Mining</span>
                        <span class="text-xs text-gray-600 mt-1">Extract Evidence</span>
                    </div>
                    
                    <!-- Step 3: Forensic Audit -->
                    <div class="step-item flex flex-col items-center" data-step="auditing">
                        <div class="w-10 h-10 rounded-full bg-slate-700 border-2 border-slate-600 flex items-center justify-center mb-2 transition-all">
                            <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                            </svg>
                        </div>
                        <span class="text-sm text-gray-400 font-medium">Auditing</span>
                        <span class="text-xs text-gray-600 mt-1">Safety Review</span>
                    </div>
                    
                    <!-- Step 4: Report Writing -->
                    <div class="step-item flex flex-col items-center" data-step="writing">
                        <div class="w-10 h-10 rounded-full bg-slate-700 border-2 border-slate-600 flex items-center justify-center mb-2 transition-all">
                            <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                            </svg>
                        </div>
                        <span class="text-sm text-gray-400 font-medium">Writing</span>
                        <span class="text-xs text-gray-600 mt-1">Final Report</span>
                    </div>
                </div>
            </div>
            
            <!-- Live Logs -->
            <div class="mt-8">
                <div class="flex items-center justify-between mb-3">
                    <h4 class="text-sm font-semibold text-gray-300">Real-Time Logs</h4>
                    <button id="clearLogs" class="text-xs text-gray-500 hover:text-gray-300">Clear</button>
                </div>
                <div id="logContainer" class="bg-slate-950 rounded-lg p-4 h-64 overflow-y-auto font-mono text-xs space-y-1">
                    <div class="text-gray-500">Waiting for analysis to start...</div>
                </div>
            </div>
            
            <!-- Results -->
            <div id="resultsSection" class="mt-6 hidden">
                <div class="bg-emerald-500/10 border border-emerald-500/30 rounded-xl p-6">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-2">
                                <svg class="w-6 h-6 text-emerald-400" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                </svg>
                                <h4 class="text-lg font-bold text-emerald-400">Analysis Complete</h4>
                            </div>
                            <p class="text-gray-300" id="completionMessage">Report generated successfully</p>
                        </div>
                        <a id="downloadBtn" href="#" download class="px-6 py-3 bg-emerald-600 hover:bg-emerald-500 text-white font-semibold rounded-lg transition-colors">
                            <span class="flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                Download PDF Report
                            </span>
                        </a>
                    </div>
                    
                    <!-- Full Report Viewer (Collapsible) -->
                    <div id="fullReportContainer" class="mt-6 hidden">
                        <button id="toggleReportBtn" class="w-full flex items-center justify-between px-4 py-3 bg-slate-800/50 hover:bg-slate-800 rounded-lg transition-colors border border-slate-700">
                            <span class="text-emerald-400 font-semibold">üìÑ View Complete Report</span>
                            <svg id="toggleIcon" class="w-5 h-5 text-gray-400 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        <div id="fullReportContent" class="hidden mt-4 bg-white rounded-lg p-8 shadow-lg overflow-y-auto max-h-[600px] prose prose-slate max-w-none">
                            <!-- Markdown will be rendered here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // ===== PHASE 3.2: SPA Functionality & localStorage Persistence =====
    
    // Function to show Reports tab (called from sidebar)
    function showReportsTab() {
        const lastReport = localStorage.getItem('last_report');
        if (lastReport) {
            try {
                const reportData = JSON.parse(lastReport);
                // Restore the report view
                restoreReportFromStorage(reportData);
                // Scroll to results
                document.getElementById('resultsSection')?.scrollIntoView({ behavior: 'smooth' });
            } catch (e) {
                console.error('Failed to parse stored report:', e);
                alert('No recent report found in cache. Please run a new analysis.');
            }
        } else {
            alert('No recent report found. Please run an analysis first.');
        }
    }
    
    // Function to restore report from localStorage
    function restoreReportFromStorage(reportData) {
        const resultsSection = document.getElementById('resultsSection');
        resultsSection.classList.remove('hidden');
        
        const summary = reportData.summary || {};
        const executiveSummary = reportData.executive_summary || '';
        
        // Rebuild the summary HTML (same logic as socket handler)
        let summaryHTML = '';
        
        if (executiveSummary && executiveSummary.length > 50) {
            const riskLevel = executiveSummary.toLowerCase().includes('high risk') ? 'HIGH RISK' :
                             executiveSummary.toLowerCase().includes('medium risk') ? 'MEDIUM RISK' :
                             executiveSummary.toLowerCase().includes('avoid') ? 'CAUTION' : 'ANALYSIS';
            
            const riskColor = riskLevel === 'HIGH RISK' ? 'text-red-400' :
                             riskLevel === 'MEDIUM RISK' ? 'text-yellow-400' :
                             riskLevel === 'CAUTION' ? 'text-orange-400' : 'text-emerald-400';
            
            const riskBg = riskLevel === 'HIGH RISK' ? 'bg-red-950/40 border-red-800/50' :
                          riskLevel === 'MEDIUM RISK' ? 'bg-yellow-950/40 border-yellow-800/50' :
                          riskLevel === 'CAUTION' ? 'bg-orange-950/40 border-orange-800/50' : 'bg-emerald-950/40 border-emerald-800/50';
            
            summaryHTML = `
                <div class="${riskBg} rounded-xl p-6 border-2 mb-4 font-mono">
                    <div class="flex items-start gap-4">
                        <div class="flex-shrink-0 mt-1">
                            <svg class="w-8 h-8 ${riskColor}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-3">
                                <span class="${riskColor} font-bold text-lg tracking-wider">[${riskLevel} DETECTED]</span>
                                <span class="text-gray-500 text-sm">// Strategic Assessment (Restored)</span>
                            </div>
                            <div class="text-gray-300 leading-relaxed whitespace-pre-wrap">${executiveSummary}</div>
                            <div class="mt-4 pt-4 border-t border-slate-700/50 flex items-center justify-between text-sm">
                                <div class="flex gap-4 text-gray-500">
                                    <span>üìä ${summary.harvested_items || 0} sources</span>
                                    <span>üîç ${summary.text_evidence || 0} evidence</span>
                                    <span>üñºÔ∏è ${summary.forensic_evidence || 0} forensics</span>
                                </div>
                                <button onclick="document.getElementById('downloadBtn').click()" class="text-emerald-400 hover:text-emerald-300 font-semibold">Read Full Report ‚Üí</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        } else {
            summaryHTML = '<div class="text-gray-400 text-center p-4">Report summary unavailable</div>';
        }
        
        document.getElementById('completionMessage').innerHTML = summaryHTML;
        
        // Restore full report if available
        const fullMarkdown = reportData.full_report_markdown || '';
        if (fullMarkdown && typeof marked !== 'undefined') {
            const reportContainer = document.getElementById('fullReportContainer');
            const reportContent = document.getElementById('fullReportContent');
            
            reportContainer.classList.remove('hidden');
            reportContent.innerHTML = marked.parse(fullMarkdown);
        }
    }
    
    // On page load, check for stored report
    window.addEventListener('DOMContentLoaded', () => {
        const lastReport = localStorage.getItem('last_report');
        if (lastReport) {
            console.log('Found cached report, available via Reports tab');
        }
    });
    
    // ===== End Phase 3.2 Functions =====
    
    // Quick query buttons
    document.querySelectorAll('.quick-query').forEach(btn => {
        btn.addEventListener('click', () => {
            document.getElementById('queryInput').value = btn.dataset.query;
        });
    });
    
    // Keyboard shortcut
    document.getElementById('queryInput').addEventListener('keydown', (e) => {
        if (e.ctrlKey && e.key === 'Enter') {
            document.getElementById('queryForm').dispatchEvent(new Event('submit'));
        }
    });
    
    // File upload handling
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const fileList = document.getElementById('fileList');
    let uploadedFiles = [];
    
    dropZone.addEventListener('click', () => fileInput.click());
    
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('border-emerald-500', 'bg-emerald-500/5');
    });
    
    dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('border-emerald-500', 'bg-emerald-500/5');
    });
    
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('border-emerald-500', 'bg-emerald-500/5');
        handleFiles(e.dataTransfer.files);
    });
    
    fileInput.addEventListener('change', (e) => {
        handleFiles(e.target.files);
    });
    
    function handleFiles(files) {
        Array.from(files).forEach(file => {
            if (file.type === 'application/pdf') {
                uploadedFiles.push(file);
                addFileToList(file);
            }
        });
    }
    
    function addFileToList(file) {
        const fileItem = document.createElement('div');
        fileItem.className = 'flex items-center justify-between bg-slate-900 rounded-lg p-3';
        fileItem.innerHTML = `
            <div class="flex items-center gap-3">
                <svg class="w-5 h-5 text-red-400" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd"></path>
                </svg>
                <div>
                    <p class="text-sm text-white font-medium">${file.name}</p>
                    <p class="text-xs text-gray-500">${(file.size / 1024 / 1024).toFixed(2)} MB</p>
                </div>
            </div>
            <button class="remove-file text-gray-500 hover:text-red-400" data-name="${file.name}">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        `;
        fileList.appendChild(fileItem);
        
        fileItem.querySelector('.remove-file').addEventListener('click', () => {
            uploadedFiles = uploadedFiles.filter(f => f.name !== file.name);
            fileItem.remove();
        });
    }
    
    // Form submission
    document.getElementById('queryForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const query = document.getElementById('queryInput').value;
        const progressSection = document.getElementById('progressSection');
        const logContainer = document.getElementById('logContainer');
        const resultsSection = document.getElementById('resultsSection');
        
        // Show progress section
        progressSection.classList.remove('hidden');
        resultsSection.classList.add('hidden');
        logContainer.innerHTML = '';
        
        // Disable submit button
        const analyzeBtn = document.getElementById('analyzeBtn');
        analyzeBtn.disabled = true;
        analyzeBtn.innerHTML = '<span class="flex items-center gap-2"><svg class="animate-spin w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>Analyzing...</span></span>';
        
        // Start analysis
        try {
            const formData = new FormData();
            formData.append('query', query);
            uploadedFiles.forEach(file => formData.append('files', file));
            
            const response = await fetch('/api/analyze', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (!response.ok) {
                throw new Error(result.message || 'Analysis failed');
            }
            
            // Show that analysis has started (202 Accepted)
            if (response.status === 202) {
                addLog('success', `‚úì ${result.message}`);
                addLog('info', `Query: ${result.query}`);
                // Analysis will continue in background, WebSocket will handle updates
            } else {
                // Immediate success (synchronous response)
                resultsSection.classList.remove('hidden');
                document.getElementById('completionMessage').textContent = 
                    `Generated ${result.sections || 4} sections with ${result.evidence_count || 0} evidence items`;
                document.getElementById('downloadBtn').href = result.report_url || '#';
            }
            
        } catch (error) {
            addLog('error', `‚úó Error: ${error.message}`);
        } finally {
            // Keep button disabled until WebSocket signals completion
            // analyzeBtn.disabled = false;
            // analyzeBtn.innerHTML = '<span class="flex items-center space-x-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg><span>Launch Analysis</span></span>';
        }
    });
    
    // Step progress tracking
    function updateStep(step, status) {
        const stepEl = document.querySelector(`[data-step="${step}"]`);
        if (!stepEl) return;
        const circle = stepEl.querySelector('div');
        const svg = circle.querySelector('svg');
        
        if (status === 'active') {
            circle.className = 'w-10 h-10 rounded-full bg-emerald-600 border-2 border-emerald-400 flex items-center justify-center mb-2 pulse-safe';
            if (svg) {
                svg.classList.remove('text-gray-500');
                svg.classList.add('text-white');
            }
        } else if (status === 'complete') {
            circle.className = 'w-10 h-10 rounded-full bg-emerald-600 border-2 border-emerald-400 flex items-center justify-center mb-2';
            circle.innerHTML = '<svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>';
        }
        
        // Update progress bar
        const steps = ['harvest', 'mining', 'auditing', 'writing'];
        const currentIndex = steps.indexOf(step);
        const progress = ((currentIndex + 1) / steps.length) * 100;
        document.getElementById('progressBar').style.width = `${progress}%`;
    }
    
    // Log system
    function addLog(type, message) {
        const logContainer = document.getElementById('logContainer');
        const logEntry = document.createElement('div');
        const timestamp = new Date().toLocaleTimeString();
        
        let icon = '‚óè';
        let color = 'text-gray-400';
        
        if (type === 'success') {
            icon = '‚úì';
            color = 'text-emerald-400';
        } else if (type === 'error') {
            icon = '‚úó';
            color = 'text-red-400';
        } else if (type === 'warning') {
            icon = '‚ö†';
            color = 'text-yellow-400';
        }
        
        logEntry.className = color;
        logEntry.innerHTML = `<span class="text-gray-600">[${timestamp}]</span> ${icon} ${message}`;
        logContainer.appendChild(logEntry);
        logContainer.scrollTop = logContainer.scrollHeight;
    }
    
    document.getElementById('clearLogs').addEventListener('click', () => {
        document.getElementById('logContainer').innerHTML = '<div class="text-gray-500">Logs cleared</div>';
    });
    
    // Socket.IO for real-time updates (if available)
    if (typeof io !== 'undefined') {
        const socket = io();
        
        socket.on('log', (data) => {
            addLog(data.level || 'info', data.message);
        });
        
        socket.on('step', (data) => {
            updateStep(data.step, data.status);
        });
        
        socket.on('analysis_complete', (data) => {
            // PHASE 3.2 FIX: Save report to localStorage immediately to prevent data loss
            const reportData = {
                timestamp: new Date().toISOString(),
                executive_summary: data.executive_summary || '',
                full_report_markdown: data.full_report_markdown || '',
                summary: data.summary || {},
                report_path: data.report_path
            };
            localStorage.setItem('last_report', JSON.stringify(reportData));
            
            // Show completion
            const resultsSection = document.getElementById('resultsSection');
            resultsSection.classList.remove('hidden');
            
            const summary = data.summary || {};
            const executiveSummary = data.executive_summary || '';
            
            // Text-First Intelligence Card Design
            let summaryHTML = '';
            
            if (executiveSummary && executiveSummary.length > 50) {
                // PRIMARY: Show AI analysis with Terminal aesthetic
                const riskLevel = executiveSummary.toLowerCase().includes('high risk') ? 'HIGH RISK' :
                                 executiveSummary.toLowerCase().includes('medium risk') ? 'MEDIUM RISK' :
                                 executiveSummary.toLowerCase().includes('avoid') ? 'CAUTION' : 'ANALYSIS';
                
                const riskColor = riskLevel === 'HIGH RISK' ? 'text-red-400' :
                                 riskLevel === 'MEDIUM RISK' ? 'text-yellow-400' :
                                 riskLevel === 'CAUTION' ? 'text-orange-400' : 'text-emerald-400';
                
                const riskBg = riskLevel === 'HIGH RISK' ? 'bg-red-950/40 border-red-800/50' :
                              riskLevel === 'MEDIUM RISK' ? 'bg-yellow-950/40 border-yellow-800/50' :
                              riskLevel === 'CAUTION' ? 'bg-orange-950/40 border-orange-800/50' : 'bg-emerald-950/40 border-emerald-800/50';
                
                summaryHTML = `
                    <!-- Strategic Intelligence Card -->
                    <div class="${riskBg} rounded-xl p-6 border-2 mb-4 font-mono">
                        <div class="flex items-start gap-4">
                            <div class="flex-shrink-0 mt-1">
                                <svg class="w-8 h-8 ${riskColor}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <div class="flex items-center gap-3 mb-3">
                                    <span class="${riskColor} font-bold text-lg tracking-wider">[${riskLevel} DETECTED]</span>
                                    <span class="text-gray-500 text-sm">// Strategic Assessment</span>
                                </div>
                                <div class="text-gray-300 leading-relaxed whitespace-pre-wrap">${executiveSummary}</div>
                                <div class="mt-4 pt-4 border-t border-slate-700/50 flex items-center justify-between text-sm">
                                    <div class="flex gap-4 text-gray-500">
                                        <span>üìä ${summary.harvested_items || 0} sources</span>
                                        <span>üîç ${summary.text_evidence || 0} evidence</span>
                                        <span>üñºÔ∏è ${summary.forensic_evidence || 0} forensics</span>
                                    </div>
                                    <button onclick="document.getElementById('downloadBtn').click()" class="text-emerald-400 hover:text-emerald-300 font-semibold">Read Full Report ‚Üí</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                // FALLBACK: Show stats-only view if no executive summary
                summaryHTML = `
                    <div class="bg-slate-800/50 rounded-xl p-6 border border-slate-700">
                        <div class="text-center">
                            <div class="text-emerald-400 font-bold text-xl mb-3">‚úÖ Analysis Complete</div>
                            <div class="grid grid-cols-3 gap-4 text-center mt-4">
                                <div class="bg-slate-900/50 rounded-lg p-4">
                                    <div class="text-3xl font-bold text-white">${summary.harvested_items || 0}</div>
                                    <div class="text-sm text-gray-400 mt-1">Papers/Trials</div>
                                </div>
                                <div class="bg-slate-900/50 rounded-lg p-4">
                                    <div class="text-3xl font-bold text-white">${summary.text_evidence || 0}</div>
                                    <div class="text-sm text-gray-400 mt-1">Evidence Items</div>
                                </div>
                                <div class="bg-slate-900/50 rounded-lg p-4">
                                    <div class="text-3xl font-bold text-white">${summary.forensic_evidence || 0}</div>
                                    <div class="text-sm text-gray-400 mt-1">Forensic Findings</div>
                                </div>
                            </div>
                            <p class="text-gray-400 mt-4">üìÑ Full report ready for download below</p>
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('completionMessage').innerHTML = summaryHTML;
            
            // Render full report in viewer (if available)
            const fullMarkdown = data.full_report_markdown || '';
            if (fullMarkdown && typeof marked !== 'undefined') {
                const reportContainer = document.getElementById('fullReportContainer');
                const reportContent = document.getElementById('fullReportContent');
                const toggleBtn = document.getElementById('toggleReportBtn');
                const toggleIcon = document.getElementById('toggleIcon');
                
                reportContainer.classList.remove('hidden');
                
                // Render Markdown to HTML
                reportContent.innerHTML = marked.parse(fullMarkdown);
                
                // Toggle functionality
                toggleBtn.addEventListener('click', () => {
                    reportContent.classList.toggle('hidden');
                    toggleIcon.classList.toggle('rotate-180');
                });
            }
            
            // Enable download button
            const downloadBtn = document.getElementById('downloadBtn');
            if (data.report_path) {
                downloadBtn.href = `/api/reports/latest?format=pdf`;
                downloadBtn.onclick = async (e) => {
                    e.preventDefault();
                    window.location.href = `/api/reports/latest?format=pdf`;
                };
            }
            
            // Re-enable analyze button
            const analyzeBtn = document.getElementById('analyzeBtn');
            analyzeBtn.disabled = false;
            analyzeBtn.innerHTML = '<span class="flex items-center space-x-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg><span>Launch Analysis</span></span>';
            
            addLog('success', '‚úÖ Strategic assessment complete!');
        });
        
        socket.on('analysis_error', (data) => {
            addLog('error', `‚úó Analysis failed: ${data.error}`);
            
            // Re-enable analyze button
            const analyzeBtn = document.getElementById('analyzeBtn');
            analyzeBtn.disabled = false;
            analyzeBtn.innerHTML = '<span class="flex items-center space-x-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg><span>Launch Analysis</span></span>';
        });
    }
</script>
{% endblock %}
