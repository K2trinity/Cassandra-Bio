{% extends "base.html" %}

{% block title %}Knowledge Graph - Cassandra{% endblock %}

{% block head %}
<!-- Force Graph 3D Library -->
<script src="https://unpkg.com/3d-force-graph@1.73.3/dist/3d-force-graph.min.js"></script>
<script src="https://unpkg.com/force-graph@1.43.0/dist/force-graph.min.js"></script>
<style>
    #graph-container {
        width: 100%;
        height: calc(100vh - 200px);
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        border-radius: 16px;
        position: relative;
        overflow: hidden;
    }
    
    .graph-controls {
        position: absolute;
        top: 20px;
        left: 20px;
        z-index: 10;
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
    }
    
    .control-btn {
        padding: 12px 20px;
        background: rgba(15, 23, 42, 0.9);
        border: 1px solid #334155;
        color: white;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        backdrop-filter: blur(10px);
    }
    
    .control-btn:hover {
        background: rgba(16, 185, 129, 0.2);
        border-color: #10b981;
        transform: translateY(-2px);
    }
    
    .control-btn.active {
        background: #10b981;
        border-color: #10b981;
    }
    
    .graph-stats {
        position: absolute;
        bottom: 20px;
        left: 20px;
        z-index: 10;
        padding: 16px 20px;
        background: rgba(15, 23, 42, 0.95);
        border: 1px solid #334155;
        border-radius: 12px;
        color: white;
        font-family: monospace;
        font-size: 13px;
        backdrop-filter: blur(10px);
    }
    
    .graph-stats .stat-row {
        display: flex;
        justify-content: space-between;
        gap: 20px;
        margin-bottom: 8px;
    }
    
    .graph-stats .stat-label {
        color: #94a3b8;
    }
    
    .graph-stats .stat-value {
        color: #10b981;
        font-weight: bold;
    }
    
    .graph-legend {
        position: absolute;
        top: 20px;
        right: 20px;
        z-index: 10;
        padding: 16px;
        background: rgba(15, 23, 42, 0.95);
        border: 1px solid #334155;
        border-radius: 12px;
        color: white;
        font-size: 12px;
        backdrop-filter: blur(10px);
        max-width: 200px;
    }
    
    .legend-title {
        font-weight: bold;
        margin-bottom: 12px;
        color: #10b981;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 8px;
    }
    
    .legend-color {
        width: 16px;
        height: 16px;
        border-radius: 50%;
    }
    
    .search-box {
        position: absolute;
        top: 80px;
        left: 20px;
        z-index: 10;
        width: 300px;
    }
    
    .search-box input {
        width: 100%;
        padding: 12px 16px;
        background: rgba(15, 23, 42, 0.95);
        border: 1px solid #334155;
        border-radius: 8px;
        color: white;
        font-size: 14px;
        backdrop-filter: blur(10px);
    }
    
    .search-box input:focus {
        outline: none;
        border-color: #10b981;
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }
    
    .node-tooltip {
        position: absolute;
        padding: 12px 16px;
        background: rgba(15, 23, 42, 0.98);
        border: 1px solid #10b981;
        border-radius: 8px;
        color: white;
        font-size: 13px;
        pointer-events: none;
        z-index: 100;
        max-width: 300px;
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);
    }
    
    .tooltip-title {
        font-weight: bold;
        color: #10b981;
        margin-bottom: 8px;
        font-size: 15px;
    }
    
    .tooltip-prop {
        color: #94a3b8;
        margin: 4px 0;
    }
    
    .pulse-animation {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
</style>
{% endblock %}

{% block content %}
<div id="graphTab" class="flex-1 flex flex-col">
    <!-- Header -->
    <header class="bg-slate-950 border-b border-slate-800 px-8 py-4">
        <div class="flex items-center justify-between">
            <div>
                <h2 class="text-2xl font-bold text-white">üß† Global Knowledge Graph</h2>
                <p class="text-sm text-gray-400 mt-1">CassandraÁöÑÈïøÊúüËÆ∞ÂøÜ - Ëá™Âä®ÊûÑÂª∫ÁîüÁâ©ÂåªËçØÊ¨∫ËØàÁΩëÁªú</p>
            </div>
            <div class="flex items-center space-x-4">
                <div class="flex items-center space-x-2 px-4 py-2 bg-slate-800 rounded-lg">
                    <div class="w-2 h-2 bg-emerald-400 rounded-full pulse-animation"></div>
                    <span class="text-sm text-gray-300">Neo4j Connected</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Graph Container -->
    <div class="flex-1 p-8">
        <div id="graph-container" class="shadow-2xl border border-slate-700">
            <!-- Controls -->
            <div class="graph-controls">
                <button id="btnGlobalView" class="control-btn active" onclick="loadGlobalGraph()">
                    üåç Global Brain
                </button>
                <button id="btnDrugView" class="control-btn" onclick="showDrugSearch()">
                    üíä Drug Analysis
                </button>
                <button id="btn3D" class="control-btn" onclick="toggle3D()">
                    üé≤ Toggle 3D
                </button>
                <button id="btnReset" class="control-btn" onclick="resetGraph()">
                    üîÑ Reset View
                </button>
            </div>
            
            <!-- Search Box (hidden by default) -->
            <div class="search-box" id="searchBox" style="display: none;">
                <input 
                    type="text" 
                    id="drugSearchInput" 
                    placeholder="Enter drug name (e.g., Simufilam)" 
                    onkeypress="if(event.key==='Enter') searchDrug()"
                />
            </div>
            
            <!-- Legend -->
            <div class="graph-legend">
                <div class="legend-title">Node Types</div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ef4444;"></div>
                    <span>Drug</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #f59e0b;"></div>
                    <span>Paper</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #10b981;"></div>
                    <span>Author</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #3b82f6;"></div>
                    <span>Clinical Trial</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #8b5cf6;"></div>
                    <span>Adverse Event</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ec4899;"></div>
                    <span>Company</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #dc2626;"></div>
                    <span>Warning</span>
                </div>
            </div>
            
            <!-- Stats -->
            <div class="graph-stats">
                <div class="stat-row">
                    <span class="stat-label">Nodes:</span>
                    <span class="stat-value" id="statNodes">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Relationships:</span>
                    <span class="stat-value" id="statLinks">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">View Mode:</span>
                    <span class="stat-value" id="statMode">Global</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Dimension:</span>
                    <span class="stat-value" id="statDimension">2D</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let graphInstance = null;
let currentData = null;
let is3D = false;
let currentDrug = null;

// Color mapping for node types
const nodeColors = {
    'Drug': '#ef4444',
    'Paper': '#f59e0b',
    'Author': '#10b981',
    'ClinicalTrial': '#3b82f6',
    'AdverseEvent': '#8b5cf6',
    'Company': '#ec4899',
    'RegulatoryWarning': '#dc2626',
    'Unknown': '#6b7280'
};

// Initialize graph on page load
window.addEventListener('DOMContentLoaded', () => {
    loadGlobalGraph();
    
    // Connect to SocketIO for real-time updates
    connectWebSocket();
});

function loadGlobalGraph() {
    document.getElementById('btnGlobalView').classList.add('active');
    document.getElementById('btnDrugView').classList.remove('active');
    document.getElementById('searchBox').style.display = 'none';
    document.getElementById('statMode').textContent = 'Global';
    currentDrug = null;
    
    fetch('/api/graph/global')
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                currentData = data;
                renderGraph(data);
                updateStats(data);
            }
        })
        .catch(err => {
            console.error('Failed to load global graph:', err);
        });
}

function showDrugSearch() {
    document.getElementById('btnGlobalView').classList.remove('active');
    document.getElementById('btnDrugView').classList.add('active');
    document.getElementById('searchBox').style.display = 'block';
    document.getElementById('drugSearchInput').focus();
}

function searchDrug() {
    const drugName = document.getElementById('drugSearchInput').value.trim();
    if (!drugName) return;
    
    currentDrug = drugName;
    document.getElementById('statMode').textContent = `Drug: ${drugName}`;
    
    fetch(`/api/graph/drug/${encodeURIComponent(drugName)}`)
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                currentData = data;
                renderGraph(data);
                updateStats(data);
            }
        })
        .catch(err => {
            console.error('Failed to load drug graph:', err);
        });
}

function renderGraph(data) {
    const container = document.getElementById('graph-container');
    
    // Clear existing graph
    if (graphInstance) {
        container.innerHTML = '';
        // Restore UI elements
        container.innerHTML = `
            <div class="graph-controls">
                <button id="btnGlobalView" class="control-btn ${!currentDrug ? 'active' : ''}" onclick="loadGlobalGraph()">üåç Global Brain</button>
                <button id="btnDrugView" class="control-btn ${currentDrug ? 'active' : ''}" onclick="showDrugSearch()">üíä Drug Analysis</button>
                <button id="btn3D" class="control-btn" onclick="toggle3D()">üé≤ Toggle 3D</button>
                <button id="btnReset" class="control-btn" onclick="resetGraph()">üîÑ Reset View</button>
            </div>
            <div class="search-box" id="searchBox" style="display: ${currentDrug ? 'block' : 'none'};">
                <input type="text" id="drugSearchInput" placeholder="Enter drug name (e.g., Simufilam)" onkeypress="if(event.key==='Enter') searchDrug()" value="${currentDrug || ''}"/>
            </div>
            <div class="graph-legend">
                <div class="legend-title">Node Types</div>
                <div class="legend-item"><div class="legend-color" style="background: #ef4444;"></div><span>Drug</span></div>
                <div class="legend-item"><div class="legend-color" style="background: #f59e0b;"></div><span>Paper</span></div>
                <div class="legend-item"><div class="legend-color" style="background: #10b981;"></div><span>Author</span></div>
                <div class="legend-item"><div class="legend-color" style="background: #3b82f6;"></div><span>Clinical Trial</span></div>
                <div class="legend-item"><div class="legend-color" style="background: #8b5cf6;"></div><span>Adverse Event</span></div>
                <div class="legend-item"><div class="legend-color" style="background: #ec4899;"></div><span>Company</span></div>
                <div class="legend-item"><div class="legend-color" style="background: #dc2626;"></div><span>Warning</span></div>
            </div>
            <div class="graph-stats">
                <div class="stat-row"><span class="stat-label">Nodes:</span><span class="stat-value" id="statNodes">0</span></div>
                <div class="stat-row"><span class="stat-label">Relationships:</span><span class="stat-value" id="statLinks">0</span></div>
                <div class="stat-row"><span class="stat-label">View Mode:</span><span class="stat-value" id="statMode">${currentDrug || 'Global'}</span></div>
                <div class="stat-row"><span class="stat-label">Dimension:</span><span class="stat-value" id="statDimension">${is3D ? '3D' : '2D'}</span></div>
            </div>
        `;
    }
    
    // Create new graph instance
    if (is3D) {
        graphInstance = ForceGraph3D()(container)
            .graphData({
                nodes: data.nodes.map(n => ({...n})),
                links: data.links.map(l => ({...l}))
            })
            .nodeLabel(node => `
                <div style="background: rgba(15, 23, 42, 0.98); padding: 12px; border-radius: 8px; border: 1px solid #10b981;">
                    <div style="font-weight: bold; color: #10b981; margin-bottom: 8px;">${node.name}</div>
                    <div style="color: #94a3b8;">Type: ${node.label}</div>
                    ${node.properties && node.properties.suspicious ? '<div style="color: #ef4444;">‚ö†Ô∏è Suspicious</div>' : ''}
                </div>
            `)
            .nodeColor(node => {
                if (node.isDrugCenter) return '#fbbf24'; // Gold for center drug
                if (node.properties && node.properties.suspicious) return '#ef4444'; // Red for suspicious
                return nodeColors[node.label] || nodeColors['Unknown'];
            })
            .nodeVal(node => node.isDrugCenter ? 20 : 8)
            .linkColor(link => link.properties && link.properties.suspicious ? '#ef4444' : '#475569')
            .linkWidth(2)
            .linkOpacity(0.6)
            .linkDirectionalParticles(2)
            .linkDirectionalParticleSpeed(0.005)
            .backgroundColor('#0f172a');
    } else {
        graphInstance = ForceGraph()(container)
            .graphData({
                nodes: data.nodes.map(n => ({...n})),
                links: data.links.map(l => ({...l}))
            })
            .nodeLabel(node => `
                <div class="node-tooltip">
                    <div class="tooltip-title">${node.name}</div>
                    <div class="tooltip-prop">Type: ${node.label}</div>
                    ${node.properties && node.properties.company ? `<div class="tooltip-prop">Company: ${node.properties.company}</div>` : ''}
                    ${node.properties && node.properties.suspicious ? '<div style="color: #ef4444;">‚ö†Ô∏è Suspicious Activity</div>' : ''}
                    ${node.properties && node.properties.retracted ? '<div style="color: #ef4444;">üö´ Retracted</div>' : ''}
                </div>
            `)
            .nodeColor(node => {
                if (node.isDrugCenter) return '#fbbf24';
                if (node.properties && node.properties.suspicious) return '#ef4444';
                return nodeColors[node.label] || nodeColors['Unknown'];
            })
            .nodeVal(node => node.isDrugCenter ? 20 : 8)
            .linkColor(link => '#475569')
            .linkWidth(2)
            .linkDirectionalParticles(2)
            .linkDirectionalParticleSpeed(0.005)
            .onNodeClick(node => {
                console.log('Clicked node:', node);
                // Could implement drill-down here
            });
    }
}

function toggle3D() {
    is3D = !is3D;
    document.getElementById('statDimension').textContent = is3D ? '3D' : '2D';
    if (currentData) {
        renderGraph(currentData);
    }
}

function resetGraph() {
    if (graphInstance) {
        if (is3D) {
            graphInstance.cameraPosition({ x: 0, y: 0, z: 1000 });
        } else {
            graphInstance.zoomToFit(400);
        }
    }
}

function updateStats(data) {
    document.getElementById('statNodes').textContent = data.nodes.length;
    document.getElementById('statLinks').textContent = data.links.length;
}

function connectWebSocket() {
    const socket = io();
    
    socket.on('connect', () => {
        console.log('üîå Connected to WebSocket for real-time graph updates');
    });
    
    // üî• ÂÆûÊó∂ÂõæË∞±Êõ¥Êñ∞
    socket.on('graph_update', (update) => {
        console.log('üìä Real-time graph update:', update);
        
        if (!currentData) return;
        
        // Add new node
        if (update.type === 'node') {
            const exists = currentData.nodes.find(n => n.id === update.data.id);
            if (!exists) {
                currentData.nodes.push(update.data);
                if (graphInstance) {
                    graphInstance.graphData(currentData);
                    updateStats(currentData);
                }
                
                // Show notification
                showNotification(`New ${update.data.label} discovered: ${update.data.name}`);
            }
        }
        
        // Add new relationship
        if (update.type === 'relationship') {
            const exists = currentData.links.find(l => 
                l.source === update.data.source && l.target === update.data.target
            );
            if (!exists) {
                currentData.links.push(update.data);
                if (graphInstance) {
                    graphInstance.graphData(currentData);
                    updateStats(currentData);
                }
            }
        }
    });
}

function showNotification(message) {
    // Create a toast notification
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed;
        top: 100px;
        right: 20px;
        padding: 16px 20px;
        background: rgba(16, 185, 129, 0.95);
        color: white;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        z-index: 1000;
        animation: slideIn 0.3s ease-out;
    `;
    toast.textContent = `‚ú® ${message}`;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease-out';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}
</script>

<style>
@keyframes slideIn {
    from { transform: translateX(400px); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

@keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(400px); opacity: 0; }
}
</style>

{% endblock %}
